!function(i){var a={anyProcess:{type:"",active:!1,timer:""},jobFinished:!1,getLogs:!1};function o(){var e={action:"onestg_get_staging",nonce:wpstg.nonce};i.ajax({url:ajaxurl,type:"POST",data:e,error:function(e,t,o){console.log(e.status+" "+e.statusText+"---"+t),i("#onme_errors").html("").html("Failed to get staging details, please reload the page and try again.")},success:function(e){i(document).find("#staging_entry").slideUp().remove(),i("#staging-create").slideUp("fast").before(e),i(".one-staging-msg").removeClass("hide"),window.location.reload()},statusCode:{200:function(){},404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}function t(){var e={action:"onestg_scanning",nonce:wpstg.nonce};i.ajax({url:ajaxurl,type:"POST",data:e,error:function(e,t,o){console.log(e.status+" "+e.statusText+"---"+t),f()},success:function(e){!0===e.error?f(e.message):(i("#dir_list").html("").html(e),i("#dir_list").length&&i("#dir_list").find(".wpstg-expand-dirs").bind("click",function(e){e.preventDefault(),i(this).hasClass("disabled")||i(this).siblings(".wpstg-subdir").slideToggle()}),e={action:"onestg_check_disk_space",nonce:wpstg.nonce},i.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,o){console.log(e.status+" "+e.statusText+"---"+t),f()},success:function(e){var t,o,n,r,s,a;!0===e.error?f(e.message):!1===e?i("#onme_errors").text("Can not detect disk space.").show():(w(wpstg.msgPrep,0,0),t=wpstg.stgID,o=wpstg.stgPrefix,n=c(),r=l(),s=g(),a=d(),data={action:"onestg_cloning",nonce:wpstg.nonce,cloneID:t,stgPrefix:o,excludedTables:n,includedDirectories:r,excludedDirectories:s,extraDirectories:a},i.ajax({url:ajaxurl,type:"POST",data:data,error:function(e,t,o){console.log(e.status+" "+e.statusText),f()},success:function(e){void 0!==e.error&&void 0!==e.message?f(e.message):(w(wpstg.msgPrep,100,0),u())},statusCode:{404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}}),i("#av_space").html("Available free disk space "+e.freespace+" <br> Estimated necessary disk space: "+e.usedspace).show())},statusCode:{200:function(){},404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}}))},statusCode:{200:function(){},404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}function n(){var e=i("#console_log");void 0!==e[0]&&e.scrollTop(e[0].scrollHeight)}function r(e){null!=e&&void 0!==e&&e.constructor===Array&&i.each(e,function(e,t){}),n()}function c(){var e=[];return i(".onestaging-db-table input:not(:checked)").each(function(){e.push(this.name)}),e}function l(){var t=[];return i(".wpstg-dir input:checked").each(function(){var e=i(this);e.parent(".wpstg-dir").parents(".wpstg-dir").children(".wpstg-expand-dirs").hasClass("disabled")||t.push(e.val())}),t}function g(){var t=[];return i(".wpstg-dir input:not(:checked)").each(function(){var e=i(this);e.parent(".wpstg-dir").parents(".wpstg-dir").children(".wpstg-expand-dirs").hasClass("disabled")||t.push(e.val())}),t}function d(){var e=[];if(!i("#wpstg_extraDirectories").val())return e;e=i("#wpstg_extraDirectories").val().split(/\r?\n/);return console.log(e),e}function u(){w(wpstg.msgNewStg,0,0),setTimeout(function(){w(wpstg.msgCopyDB,0,0),function t(){!0===a.getLogs&&r();setTimeout(function(){var e={action:"onestg_clone_database",nonce:wpstg.nonce};i.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,o){console.log(e.status+" "+e.statusText),f()},success:function(e){void 0!==e.error&&void 0!==e.message?f(e.message):(w(wpstg.msgCopyDB,e.percentage,0),void 0!==e.last_msg&&r(e.last_msg),!1===e.status?setTimeout(function(){t()},wpstg.cpuLoad):!0===e.status&&setTimeout(function(){w(wpstg.msgPrepDirs,0,0),s()},wpstg.cpuLoad))},statusCode:{404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})},500)}()},wpstg.cpuLoad)}function s(){if(!0===a.jobFinished)return!1;!0===a.getLogs&&r(),i("#clone_log").append("Creating Directory Tree...<hr>"),setTimeout(function(){var e={action:"onestg_clone_prepare_directories",nonce:wpstg.nonce};i.ajax({url:ajaxurl,type:"POST",data:e,error:function(e,t,o){f()},success:function(e){void 0!==e.error&&void 0!==e.message?f(e.message):(w(wpstg.msgPrepDirs,e.percentage,0),void 0!==e.last_msg&&r(e.last_msg),!1===e.status?setTimeout(function(){s()},wpstg.cpuLoad):!0===e.status&&(w(wpstg.msgCopyFiles,0,0),function t(){if(!0===a.jobFinished)return!1;!0===a.getLogs&&r();var e={action:"onestg_clone_files",nonce:wpstg.nonce};i.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,o){f()},success:function(e){void 0!==e.error&&void 0!==e.message?f(e.message):(void 0!==e.percentage&&w(wpstg.msgCopyFiles,e.percentage,0),void 0!==e.last_msg&&r(e.last_msg),!1===e.status?setTimeout(function(){t()},wpstg.cpuLoad):!0===e.status&&setTimeout(function(){m()},wpstg.cpuLoad))},statusCode:{404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}()))},statusCode:{404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})},500)}function m(){if(!0===a.jobFinished)return!1;!0===a.getLogs&&r();var e={action:"onestg_clone_replace_data",nonce:wpstg.nonce};w(wpstg.msgUpdateDB,0,0),i.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,o){f()},success:function(e){void 0!==e.error&&void 0!==e.message?f(e.message):(w(wpstg.msgUpdateDB,e.percentage,0),void 0!==e.last_msg&&r(e.last_msg),!1===e.status?setTimeout(function(){m()},wpstg.cpuLoad):!0===e.status&&function t(e){if(!0===a.jobFinished)return h(e),!1;w(wpstg.msgFinalize,0,0);e=((new Date).getTime()-a.anyProcess.timer).toFixed(0);e=(e/1e3).toFixed(2);e={action:"onestg_clone_finish",nonce:wpstg.nonce,totalTime:e};i.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,o){f(),a.anyProcess.timer=""},success:function(e){if("object"!=typeof e)return console.log("Couldn't finish the cloning process properly. Your snapshot has been copied but failed to do clean up and saving its records to the database."),void(a.anyProcess.timer="");a.anyProcess.type="",a.anyProcess.active=!1,a.anyProcess.timer="",window.onbeforeunload="",o(),i(".onecom-notifier").html(wpstg.copy_msg).attr("type","success").addClass("show"),setTimeout(function(){i(".onecom-notifier").removeClass("show"),i(".one-dialog-close").trigger("click")},3e3),void 0!==e.last_msg&&r(e.last_msg),w(wpstg.msgFinished,100,1),n(),a.jobFinished=!0,t(e)},statusCode:{404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}())},statusCode:{404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}function h(e){i("#clone_area_head").find(".spinner").removeClass("is-active"),"undefined"!=e&&"undefined"!=e.url&&i("#onme_errors").html("Staging site created : "+e.url+"/wp-admin/").addClass("green").slideDown(),i(".stopwatch._clone").addClass("done")}function p(){if(!0===a.anyProcess.active)switch(a.anyProcess.type){case"stg":return"Staging creation will get interrupted if you leave or reload this page.";case"live":return"Copy staging to live will get interrupted if you leave or reload this page.";case"delete":return"Staging will not get deleted properly if you leave or reload this page.";case"update":return"Staging updation will get interrupted if you leave or reload this page.";default:return"Please do not leave the page. The current process will get interrupted."}return!0}function f(e){var t=wpstg.error_msg;void 0!==e&&e.length&&(t=e),i(".onecom-notifier").html(t).attr("type","error").addClass("show"),setTimeout(function(){i(".onecom-notifier").removeClass("show"),i(".one-dialog-close").trigger("click")},5e3),e=a.anyProcess.type,t=t,e.length&&(e={action:"onestg_clone_log_error",nonce:wpstg.nonce,stg_action:e,msg:t},i.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,o){console.log("Could not log the error"),a.anyProcess.type="",a.anyProcess.active=!1,window.onbeforeunload=""},success:function(e){a.anyProcess.type="",a.anyProcess.active=!1,window.onbeforeunload=""}}))}function w(e,t,o){e.length&&(i(".loading-overlay.show").find(".onecom_progress_bar").length?(i(".loading-overlay.show .onecom_progress_bar .job").html(e),0==t?i(".loading-overlay.show .onecom_progress_bar span").hide().width(t+"%").show():i(".loading-overlay.show .onecom_progress_bar span").width(t+"%")):(e='<div class="onecom_progress_bar" style="display: none;"><div class="job">'+e+'</div><span style="width:'+t+'%"></span></div>',i(".loading-overlay.show").find(".loader").before(e),i(".loading-overlay.show").find(".onecom_progress_bar").slideDown("fast")),o.length&&1===o&&i(".loading-overlay.show").find(".onecom_progress_bar").slideUp("fast"))}window.onbeforeunload="",i(".one-button-create-staging").on("click",function(){a.anyProcess.type="staging_create",a.anyProcess.active=!0,a.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=p,i(".loading-overlay.fullscreen-loader").not(".new-staging").addClass("show forced-center"),oc_validate_action("stg").then(function(e){"success"===e.status?(i(".loading-overlay.new-staging").addClass("show"),t(),oc_trigger_log({actionType:"wppremium_click_feature",isPremium:"true",feature:"STAGING_ENV",featureAction:"create"})):"failed"===e.status?(jQuery("#oc_um_overlay").show(),ocSetModalData({isPremium:"true",feature:"STAGING_ENV",featureAction:"create"})):e.msg&&oc_alert(e.msg,"error",5e3),i(".loading-overlay.fullscreen-loader").not(".new-staging").removeClass("show forced-center")})}),i(".one-button-update-staging").click(function(){var e=i(this).attr("data-width"),t=i(this).attr("data-height"),o=i(this).attr("data-dialog-id"),n=i(this).attr("data-title");tb_show(n,"#TB_inline?width="+e+"&height="+t+"&inlineId="+o+"&modal=true&class=thickbox",null),i("#TB_window").css({"margin-left":"-"+parseInt(e/2,10)+"px",top:"50%","margin-top":"-"+parseInt(t/2,10)+"px"})}),i(".one-button-update-staging-confirm").click(function(){oc_validate_action("stg").then(function(e){var t,o,n,r,s;"success"===e.status?(i(".loading-overlay.update-loader").addClass("show"),i(".one-dialog-close").trigger("click"),(t=i(".one-staging-entry").data("staging-id"))?(a.anyProcess.type="staging_rebuild",a.anyProcess.active=!0,a.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=p,(t=t)&&(t=t,o=c(),n=l(),r=g(),s=d(),data={action:"onestg_update",nonce:wpstg.nonce,cloneID:t,excludedTables:o,includedDirectories:n,excludedDirectories:r,extraDirectories:s},console.log("Preparing for UPDATING cloning..."),i.ajax({url:ajaxurl,type:"POST",data:data,error:function(e,t,o){f()},success:function(e){void 0!==e.error&&void 0!==e.message?f(e.message):u()},statusCode:{404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})),oc_trigger_log({actionType:"wppremium_click_feature",isPremium:"true",feature:"STAGING_ENV",featureAction:"rebuild"})):(i(".onecom-notifier").html("Error: Staging data not found.").attr("type","error").addClass("show"),setTimeout(function(){i(".onecom-notifier").removeClass("show"),i(".one-dialog-close").trigger("click")},5e3))):"failed"===e.status?(i(".one-dialog-close").trigger("click"),jQuery("#oc_um_overlay").show(),ocSetModalData({isPremium:"true",feature:"STAGING_ENV",featureAction:"rebuild"})):e.msg&&(i(".one-dialog-close").trigger("click"),oc_alert(e.msg,"error",5e3)),i(".loading-overlay.fullscreen-loader").not(".update-loader").removeClass("show forced-center")})}),i(".one-button-update-staging-cancel").click(function(){i(this).parents().find(".one-dialog-close").trigger("click")}),i(".one-button-delete-staging").click(function(){var e=i(this).attr("data-width"),t=i(this).attr("data-height"),o=i(this).attr("data-dialog-id"),n=i(this).attr("data-title");tb_show(n,"#TB_inline?width="+e+"&height="+t+"&inlineId="+o+"&modal=true&class=thickbox",null),i("#TB_window").css({height:"250px","margin-left":"-"+parseInt(e/2,10)+"px",top:"50%","margin-top":"-"+parseInt(t/2,10)+"px"})}),i(".one-button-delete-staging-confirm").click(function(){i(".loading-overlay.delete-loader").first().addClass("show");var e=i(".one-staging-entry").data("staging-id");e?(i(".one-dialog-close").trigger("click"),a.anyProcess.type="staging_delete",a.anyProcess.active=!0,a.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=p,function t(o){var e=(((new Date).getTime()-a.anyProcess.timer).toFixed(2)/1e3).toFixed(2);data={action:"onestg_delete_clone",clone:o,nonce:wpstg.nonce,excludedTables:c(),deleteDir:i("#deleteDirectory:checked").val(),totalTime:e},w(wpstg.msgDelStg,0,0),i.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:data,error:function(e,t,o){i("#onme_errors").text("Some error occurred").show(),f(data.message)},success:function(e){if(e){if(void 0!==e.error&&void 0!==e.message)return void f(e.message);if(void 0!==e.delete&&"finished"===e.delete)return w(wpstg.msgDelStg,100,1),i("#entry_"+o).fadeIn(5e3,function(){i(this).remove()}),a.anyProcess.type="",a.anyProcess.active=!1,window.onbeforeunload="",window.location.reload(),i(".onecom-notifier").html("Staging website has been removed.").attr("type","success").addClass("show"),void setTimeout(function(){i(".onecom-notifier").removeClass("show"),i(".one-dialog-close").trigger("click"),i(".one-staging-details").hide(),i(".one-staging-actions").hide(),i("#staging-create").slideDown(),i(".one-card-staging-create").fadeIn(300)},7e3)}!0!==e&&t(o)},statusCode:{404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}(e)):(i(".onecom-notifier").html("Error: Staging data not found.").attr("type","error").addClass("show"),setTimeout(function(){i(".onecom-notifier").removeClass("show"),i(".one-dialog-close").trigger("click")},5e3))}),i(".one-button-copy-to-live").click(function(){var e=i(this).attr("data-width"),t=i(this).attr("data-height"),o=i(this).attr("data-dialog-id"),n=i(this).attr("data-title");tb_show(n,"#TB_inline?width="+e+"&height="+t+"&inlineId="+o+"&modal=true&class=thickbox",null),i("#TB_window").css({height:"275px","margin-left":"-"+parseInt(e/2,10)+"px",top:"50%","margin-top":"-"+parseInt(t/2,10)+"px"})}),i(".one-button-copy-to-live-cancel, .one-button-delete-staging-cancel").click(function(){i(".one-dialog-close").trigger("click")}),i("#one-button-copy-to-live-confirm").on("click",function(){i(".loading-overlay.deploy-loader").addClass("show"),i(".one-dialog-close").trigger("click");var e,t,o,n,r=i("#deploy_to_live").data("live-id");console.log("Starting deployment Staging-to-Live : "+r),a.anyProcess.type="staging_deploy",a.anyProcess.active=!0,a.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=p,(r=r)&&(r=r,e=c(),t=l(),o=g(),n=d(),console.log(t),data={action:"onestg_deploy",nonce:wpstg.nonce,liveDirectory:r,excludedTables:e,includedDirectories:t,excludedDirectories:o,extraDirectories:n},i.ajax({url:ajaxurl,type:"POST",data:data,error:function(e,t,o){console.log(e.status+" "+e.statusText),f()},success:function(e){void 0!==e.error&&void 0!==e.message?f(e.message):u()},statusCode:{404:function(){i("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){i("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}}))}),i(".loginStaging").click(function(){var e={action:"onestg_log_attempt",nonce:wpstg.nonce};i.ajax({url:ajaxurl,type:"POST",data:e,error:function(e,t,o){},success:function(e){var t;if("object"==typeof e)return!1===e.success?(i(".onecom-notifier").html("Unable to do login into staging").attr("type","error").addClass("show"),void setTimeout(function(){i(".onecom-notifier").removeClass("show"),i(".one-dialog-close").trigger("click")},5e3)):void(!0===e.success&&(t=e.data.timelog,e=e.data.stgUrl,window.open(e+"/wp-admin/?timelog="+t+"&stgUrl="+e,"_blank")))}})})}(jQuery);